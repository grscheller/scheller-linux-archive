#!/usr/bin/env bash
#
# Backup important files to my external HD
#
# Usage: buArch
#
# shellcheck shell=bash

## Backup configuration

BackupLocation='/run/media/grs/BUSLINK/grsBackup'

ExcludeDirs=(
    devel
    Videos
    OneDrive
    .sane
    .cache
    .config/evolution
    .local/share/evolution
    .local/share/gvfs-metadata
)

ExcludeFiles=(
    .dropbox-dist
)

## Run script from home directory

cd ~ || { printf 'Error: Cannot cd to home dir\n'; exit 1; } >&2

## First, backup Evolution Mail App to filesystem before ext HD

printf 'INFO: Archiving Evolution\n' >&2

EvolutionBackupUtil=/usr/lib/evolution/evolution-backup
EvolutionBackupFile=~/info/EvolutionBackup/evolution_backup.tar.gz

if [[ ! -x $EvolutionBackupUtil ]]; then
    printf 'WARNING: Evolution backup utility, %s,\n' $EvolutionBackupUtil >&2
    printf '         either not found or not executable.\n' >&2
elif [[ ! -d ${EvolutionBackupFile%/*} ]]; then
    if mkdir -p "${EvolutionBackupFile%/*}" 
    then
        $EvolutionBackupUtil --backup "$EvolutionBackupFile" ||
            printf 'WARNING: Evolution backup failed\n' >&2
    else
        printf 'WARNING: Cannot create %s' "${EvolutionBackupFile%/*}" >&2
        printf ' directory\n' >&2
    fi
else
    $EvolutionBackupUtil --backup "$EvolutionBackupFile" ||
        printf 'WARNING: Evolution backup failed\n' >&2
fi

## Check backup location on external HD

printf '\nINFO: Checking external HD backup location\n' >&2

if [[ ! -d $BackupLocation ]]
then
    printf 'Error: backup location, %s, not found\n' "$BackupLocation" >&2
    exit 1
fi

## Backup to External HD

printf 'INFO: Now backup to external HD\n' >&2

printf -- '--exclude=%s/\n' "${ExcludeDirs[@]}" | {
   mapfile -t ExcludeDirFlags
   printf -- '--exclude=%s\n' "${ExcludeFiles[@]}" | {
      mapfile -t ExcludeFileFlags
      /usr/bin/rsync -avxP --delete \
        "${ExcludeDirFlags[@]}" \
        "${ExcludeFileFlags[@]}" \
        "${HOME}" \
        "$BackupLocation/" || {
           RSYNC_FAILURE=$?
           printf 'ERROR: rsync failure with error %s\n' "$RSYNC_FAILURE" >&2
           printf 'ERROR: Failed backing up Home directory\n' >&2
           exit 1
        }
   }
}

if (( $? == 0 ))
then
    printf 'INFO: Backup to external HD successful!\n' >&2
    exit 0
else
    printf 'WARNING: Problems with backup to external HD!\n' >&2
    exit 1
fi
